<% layout('layout') %>

 <section class="gap5 alignStart padding0" id="">
        <section class="col alignStart width35">
            <section class="justifyBetween">
                <% if ( back === "srv" ) { %>
                    <a href="/srv" class="nav"><i class="fas fa-chevron-left"></i> Go Back</a>
                <% } else if ( back === "prc") { %>
                    <a href="/prc" class="nav"><i class="fas fa-chevron-left"></i> Go Back</a>
                <% } else if ( back === "rel") { %>
                    <a href="/rel" class="nav"><i class="fas fa-chevron-left"></i> Go Back</a>
                <% } else if ( back === "apr") { %>
                    <a href="/apr" class="nav"><i class="fas fa-chevron-left"></i> Go Back</a>
                <% } else if ( back === "vrf") { %>
                    <a href="/vrf" class="nav"><i class="fas fa-chevron-left"></i> Go Back</a>
                <% } else if ( back === "dsb") { %>
                    <a href="/dsb" class="nav"><i class="fas fa-chevron-left"></i> Go Back</a>
                <% } else { %>
                    <a href="/srv" class="nav"><i class="fas fa-chevron-left"></i> Go Back</a>
                <% } %>
                <p class="rem2 str400">Request Details</p>
            </section>
            <section class="padding0 col colorPrimary">
                <section class="col alignStart abstractBG1 corner20 padding20">
                    <p class="rem18 str400"><%= request.type %></p>
                    <section class="gap5 dtl2 justifyStart padding0">
                        <p class="rem12 str400"><%= request.qty %> copies</p>
                        <p class="rem12 str400">for <%= request.purpose %> Purpose</p>
                    </section>
                    <p class="rem12 str400 bgYellow colorPrimary corner5 padding3"><%= request.amount %>P150.00</p>
                </section>
                <section class="dtlCard justifyBetween">
                    <section class="col alignStart dtl width0">
                        <p class="rem1"><i class="fas fa-receipt"></i> Date Requested</p>
                        <%
                        const options = { 
                            year: 'numeric', 
                            month: 'short', 
                            day: 'numeric', 
                            hour: 'numeric', 
                            minute: '2-digit', 
                            hour12: true 
                        }; 
                        const formattedDate = new Date(request.createdAt).toLocaleString('en-US', options); 
                        %>
                        <p class="rem14 str500"><%= formattedDate %></p>
                    </section>
                    <section class="col alignEnd dtl width0">
                        <p class="rem1"><i class="fas fa-receipt"></i> Transaction Number</p>
                        <p class="rem14 str500"><%= request.tr %></p>
                    </section>
                </section>
            </section>
            <section class="abstractBG2 col padding15 corner16 alignStart">
                <img src="<%= request.requestBy.photo ? request.requestBy.photo : '/images/profile.png' %>" alt="Profile" onerror="this.onerror=null; this.src='/images/profile.png';" class="h60 w60 corner16 shadow3">
                <p class="size20 glowImg3">
                    <%= request.requestBy ? request.requestBy.fName : '' %>
                    <%= request.requestBy ? request.requestBy.mName : '' %>
                    <%= request.requestBy ? request.requestBy.lName : '' %>
                    <%= request.requestBy ? request.requestBy.xName : '' %>
                </p>
            </section>
            <section class="col alignStart paddingLeft15">
                <p class="rem12 str500"><i class="fas fa-address-card w15"></i> <%= request.requestBy?.schoolId || "--" %></p>
                <p class="rem12 str500"><i class="fas fa-building w15"></i> <%= request.requestBy?.campus || "--" %></p>
                <p class="rem12 str500"><i class="fas fa-layer-group w15"></i> <%= request.requestBy?.course || "--" %></p>
                <p class="rem12 str500"><i class="fas fa-stream w15"></i> <%= request.requestBy?.yearLevel || "--" %></p>

                <% if (request.requestBy) { %>
                    <% if (request.requestBy.role === 'Alumni') { %>
                        <p class="rem12 str500"><i class="fas fa-graduation-cap w15"></i> <%= request.requestBy.yearGraduated || "--" %></p>
                    <% } else if (request.requestBy.role === 'Former') { %>
                        <p class="rem12 str500"><i class="fas fa-calendar w15"></i> <%= request.requestBy.yearAttended || "--" %></p>
                    <% } %>
                <% } %>

                <p class="rem12 str500"><i class="fas fa-envelope w15"></i> <%= request.requestBy?.email || "--" %></p>
                <p class="rem12 str500"><i class="fas fa-phone w15"></i> <%= request.requestBy?.phone || "--" %></p>
                <p class="rem12 str500"><i class="fas fa-house w15"></i> <%= request.requestBy?.address || "--" %></p>
            </section>
            <br><hr><br>
            <section class="col alignStart gap5">
                <p class="rem1 str400 marginLeft5">Assigned at <%= request.assignAtFormatted %></p>
                <section class="bgWhite corner10 gap5 justifyStart width0">
                    <img src="<%= request.processBy ? request.processBy.photo : '/images/profile.png' %>" alt="Profile" onerror="this.onerror=null; this.src='/images/profile.png';" class="h20 w20 wMin20 borderPrimary corner500">
                    <p class="rem12 str500"> <%= request.processBy?.fName || "--" %> <%= request.processBy?.lName || "--" %></p>
                </section>
            </section>
        </section>
        <section class="col width35">
            <section class="justifyStart hidden">
                <p class="rem2 str400">Status Tracker</p>
            </section>
            <section class="padding10 corner20 col bgWhite">
                <% if ( request.status === "Pending") { %>
                <section class="height0 justifyBetween bgSoft corner20">
                    <div class="height0 width0 gap5">
                        <a href="" class="nav cnav disabled"><i class="fas fa-scroll"></i></a>
                        <p class="upperCase str500">Registrar</p>
                    </div>
                    <a href="" class="nav disabled"><i class="fas fa-hourglass"></i> For Review</a>
                </section>

                <% } else if ( request.status === "Reviewed") { %>
                <section class="height0 justifyBetween bgSoft corner20">
                    <div class="height0 width0 gap5">
                        <a href="" class="nav cnav disabled"><i class="fas fa-scroll"></i></a>
                        <p class="upperCase str500">Registrar</p>
                    </div>
                    <a href="" class="nav disabled pnav"><i class="bi bi-patch-check-fill"></i> Reviewed</a>
                </section>


                <div class="height0 paddingLeft30 justifyBetween"><i class="fas fa-ellipsis-vertical"></i></div>

                <section class="height0 justifyBetween bgSoft corner20">
                    <div class="height0 width0 gap5">
                        <a href="" class="nav cnav disabled"><i class="fas fa-coins"></i></a>
                        <p class="upperCase str500">Accounting</p>
                    </div>
                    <a href="" class="nav disabled"><i class="fas fa-hourglass"></i> For Assessment</a>
                </section>

                <% } else if ( request.status === "Assessed") { %>
                <section class="height0 justifyBetween bgSoft corner20">
                    <div class="height0 width0 gap5">
                        <a href="" class="nav cnav disabled"><i class="fas fa-scroll"></i></a>
                        <p class="upperCase str500">Registrar</p>
                    </div>
                    <a href="" class="nav disabled pnav"><i class="bi bi-patch-check-fill"></i> Reviewed</a>
                </section>

                <div class="height0 paddingLeft30 justifyBetween"><i class="fas fa-ellipsis-vertical"></i></div>

                <section class="height0 justifyBetween bgSoft corner20">
                    <div class="height0 width0 gap5">
                        <a href="" class="nav cnav disabled"><i class="fas fa-coins"></i></a>
                        <p class="upperCase str500">Accounting</p>
                    </div>
                    <a href="" class="nav disabled pnav"><i class="bi bi-patch-check-fill"></i> Assessed</a>
                </section>

                <div class="height0 paddingLeft30 justifyBetween"><i class="fas fa-ellipsis-vertical"></i></div>

                <section class="height0 justifyBetween bgSoft corner20">
                    <div class="height0 width0 gap5">
                        <a href="" class="nav cnav disabled"><i class="fas fa-credit-card"></i></a>
                        <p class="upperCase str500">Payment</p>
                    </div>
                    <a href="" class="nav disabled"><i class="fas fa-hourglass"></i> For Payment</a>
                </section>

                <% } else if ( request.status === "For Verification") { %>
                <section class="height0 justifyBetween bgSoft corner20">
                    <div class="height0 width0 gap5">
                        <a href="" class="nav cnav disabled"><i class="fas fa-scroll"></i></a>
                        <p class="upperCase  str500">Registrar</p>
                    </div>
                    <a href="" class="nav disabled pnav"><i class="bi bi-patch-check-fill"></i> Reviewed</a>
                </section>

                <div class="height0 paddingLeft30 justifyBetween"><i class="fas fa-ellipsis-vertical"></i></div>

                <section class="height0 justifyBetween bgSoft corner20">
                    <div class="height0 width0 gap5">
                        <a href="" class="nav cnav disabled"><i class="fas fa-coins"></i></a>
                        <p class="upperCase  str500">Accounting</p>
                    </div>
                    <a href="" class="nav disabled pnav"><i class="bi bi-patch-check-fill"></i> Assessed</a>
                </section>
                
                <div class="height0 paddingLeft30 justifyBetween"><i class="fas fa-ellipsis-vertical"></i></div>

                <section class="height0 justifyBetween bgSoft corner20">
                    <div class="height0 width0 gap5">
                        <a href="" class="nav cnav disabled"><i class="fas fa-credit-card"></i></a>
                        <p class="upperCase  str500">Payment</p>
                    </div>
                    <a href="" class="nav disabled"><i class="fas fa-hourglass"></i> For Verification</a>
                </section>

                <% } else if ( request.status === "Verified") { %>
                <section class="height0 justifyBetween bgSoft corner20">
                    <div class="height0 width0 gap5">
                        <a href="" class="nav cnav disabled"><i class="fas fa-scroll"></i></a>
                        <p class="upperCase  str500">Registrar</p>
                    </div>
                    <a href="" class="nav disabled pnav"><i class="bi bi-patch-check-fill"></i> Reviewed</a>
                </section>

                <div class="height0 paddingLeft30 justifyBetween"><i class="fas fa-ellipsis-vertical"></i></div>

                <section class="height0 justifyBetween bgSoft corner20">
                    <div class="height0 width0 gap5">
                        <a href="" class="nav cnav disabled"><i class="fas fa-coins"></i></a>
                        <p class="upperCase  str500">Accounting</p>
                    </div>
                    <a href="" class="nav disabled pnav"><i class="bi bi-patch-check-fill"></i> Assessed</a>
                </section>

                <div class="height0 paddingLeft30 justifyBetween"><i class="fas fa-ellipsis-vertical"></i></div>

                <section class="height0 justifyBetween bgSoft corner20">
                    <div class="height0 width0 gap5">
                        <a href="" class="nav cnav disabled"><i class="fas fa-credit-card"></i></a>
                        <p class="upperCase  str500">Payment</p>
                    </div>
                    <a href="" class="nav disabled pnav"><i class="bi bi-patch-check-fill"></i> Verified</a>
                </section>

                <% } else if ( request.status === "For Release") { %>
                <section class="height0 justifyBetween bgSoft corner20">
                    <div class="height0 width0 gap5">
                        <a href="" class="nav cnav disabled"><i class="fas fa-scroll"></i></a>
                        <p class="upperCase  str500">Registrar</p>
                    </div>
                    <a href="" class="nav disabled pnav"><i class="bi bi-patch-check-fill"></i> Reviewed</a>
                </section>

                <div class="height0 paddingLeft30 justifyBetween"><i class="fas fa-ellipsis-vertical"></i></div>

                <section class="height0 justifyBetween bgSoft corner20">
                    <div class="height0 width0 gap5">
                        <a href="" class="nav cnav disabled"><i class="fas fa-coins"></i></a>
                        <p class="upperCase  str500">Accounting</p>
                    </div>
                    <a href="" class="nav disabled pnav"><i class="bi bi-patch-check-fill"></i> Assessed</a>
                </section>

                <div class="height0 paddingLeft30 justifyBetween"><i class="fas fa-ellipsis-vertical"></i></div>

                <section class="height0 justifyBetween bgSoft corner20">
                    <div class="height0 width0 gap5">
                        <a href="" class="nav cnav disabled"><i class="fas fa-credit-card"></i></a>
                        <p class="upperCase  str500">Payment</p>
                    </div>
                    <a href="" class="nav disabled pnav"><i class="bi bi-patch-check-fill"></i> Verified</a>
                </section>

                <div class="height0 paddingLeft30 justifyBetween"><i class="fas fa-ellipsis-vertical"></i></div>

                <section class="height0 justifyBetween bgSoft corner20">
                    <div class="height0 width0 gap5">
                        <a href="" class="nav cnav disabled"><i class="fas fa-check-circle green"></i></a>
                        <p class="upperCase  str500 green">Releasing</p>
                    </div>
                    <a href="" class="nav disabled gnav"><i class="fas fa-box-open w15"></i> For Release</a>
                </section>

                <% } else if ( request.status === "Claimed") { %>
                <section class="height0 justifyBetween bgSoft corner20">
                    <div class="height0 width0 gap5">
                        <a href="" class="nav cnav disabled"><i class="fas fa-scroll"></i></a>
                        <p class="upperCase  str500">Registrar</p>
                    </div>
                    <a href="" class="nav disabled pnav"><i class="bi bi-patch-check-fill"></i> Reviewed</a>
                </section>

                <div class="height0 paddingLeft30 justifyBetween"><i class="fas fa-ellipsis-vertical"></i></div>

                <section class="height0 justifyBetween bgSoft corner20">
                    <div class="height0 width0 gap5">
                        <a href="" class="nav cnav disabled"><i class="fas fa-coins"></i></a>
                        <p class="upperCase  str500">Accounting</p>
                    </div>
                    <a href="" class="nav disabled pnav"><i class="bi bi-patch-check-fill"></i> Assessed</a>
                </section>

                <div class="height0 paddingLeft30 justifyBetween"><i class="fas fa-ellipsis-vertical"></i></div>

                <section class="height0 justifyBetween bgSoft corner20">
                    <div class="height0 width0 gap5">
                        <a href="" class="nav cnav disabled"><i class="fas fa-credit-card"></i></a>
                        <p class="upperCase  str500">Payment</p>
                    </div>
                    <a href="" class="nav disabled pnav"><i class="bi bi-patch-check-fill"></i> Verified</a>
                </section>

                <div class="height0 paddingLeft30 justifyBetween"><i class="fas fa-ellipsis-vertical"></i></div>

                <section class="height0 justifyBetween bgSoft corner20">
                    <div class="height0 width0 gap5">
                        <a href="" class="nav cnav disabled"><i class="fas fa-check-circle"></i></a>
                        <p class="upperCase  str500">Releasing</p>
                    </div>
                    <a href="" class="nav disabled pnav"><i class="fas fa-flag w15"></i> Claimed</a>
                </section>

                <% } else { %>

                    No action was made
                <% } %>

                <% if (request.holdAt) { %>

                <div class="height0 paddingLeft30 justifyBetween red"><i class="fas fa-ellipsis-vertical"></i></div>

                <section class="height0 justifyBetween bgRed100" style="border-radius: 1.5rem !important;">
                    <div class="height0 width0 gap5 paddingInline10">
                        <%
                        const options = { 
                            year: 'numeric', 
                            month: 'short', 
                            day: 'numeric', 
                            hour: 'numeric', 
                            minute: '2-digit', 
                            hour12: true 
                        }; 
                        const formattedDate2 = new Date(request.holdAt).toLocaleString('en-US', options); 
                        %>
                        <p class=" str500"><%= formattedDate2 %></p>
                    </div>
                    <a href="" class="nav disabled dnav"><i class="fas fa-clock"></i> On Hold</a>
                </section>

                <% } %>

                <% if (request.declineAt) { %>

                <div class="height0 paddingLeft30 justifyBetween black"><i class="fas fa-ellipsis-vertical"></i></div>

                <section class="height0 justifyBetween bgRed100" style="border-radius: 1.5rem !important;">
                    <div class="height0 width0 gap5 paddingInline10">
                        <%
                        const options = { 
                            year: 'numeric', 
                            month: 'short', 
                            day: 'numeric', 
                            hour: 'numeric', 
                            minute: '2-digit', 
                            hour12: true 
                        }; 
                        const formattedDate3 = new Date(request.declineAt).toLocaleString('en-US', options); 
                        %>
                        <p class=" str500"><%= formattedDate3 %></p>
                    </div>
                    <a href="" class="nav disabled dnav"><i class="fas fa-xmark-circle"></i> Declined</a>
                </section>
                
                <% } %>

                <% if ( request.holdAt ) { %>
                <section class=" bgWhite padding0 marginTop10 relative">
                    <p class="absolute right5 top0" style="transform: rotate(45deg)!important;"><i class="fas fa-thumbtack size16"></i></p>
                    <section class="bgYellow textCenter colorPrimary col corner20 padding10" style="min-height: 60px;">
                        Your request has been hold! Due to
                        <% if ( request.remarks === "Incomplete") { %>
                            Incomplete Grades.
                        <% } else if ( request.remarks === "Balance") { %>
                            Remaining Balance on Account.
                        <% } else { %>
                        <% } %> For further assistance, please visit the Registrar’s Office on your campus, or contact us through our official hotline at <%= seedUser.phone %> or via email at <%= seedUser.email %>
                    </section>
                </section>
                <% } else if ( request.declineAt ) { %>
                <section class=" bgWhite padding0 marginTop10 relative col">
                    <p class="absolute right5 top0" style="transform: rotate(45deg)!important;"><i class="fas fa-thumbtack size16"></i></p>
                    <section class="bgYellow textCenter colorPrimary col corner20 padding10" style="min-height: 60px;">
                        We regret to inform you that your request has been declined. For further assistance, please visit the Registrar’s Office on your campus, or contact us through our official hotline at <%= seedUser.phone %> or via email at <%= seedUser.email %>
                        <% if ( request.remarks === "Incomplete") { %>
                        <% } else if ( request.remarks === "Balance") { %>
                        <% } else { %>
                        <% } %>
                    </section>
                </section>
                <% } else { %>
                <section class=" bgWhite padding0 marginTop10 relative">
                    <p class="absolute right5 top0" style="transform: rotate(45deg)!important;"><i class="fas fa-thumbtack size16"></i></p>
                    <section class="bgYellow textCenter colorPrimary col corner20 padding10" style="min-height: 60px;">
                        <% if (request.status === "Pending") { %>
                        <p class="">We have received your request, and the registrar is now reviewing it. We will notify you once it has been processed. Thank you for your patience!</p>
                        <% } else if (request.status === "Reviewed") { %>
                            <p class="">Good news! Your request has been reviewed and has now been forwarded to the Accounting Department for assessment.</p>
                        <% } else if (request.status === "Assessed") { %>
                            <p class="">Your request is now ready FOR PAYMENT. You can pay at any cashier window or pay it <span class="inline str600">ONLINE</span> at your convenience. For online payment instructions, click <a href="/pay" class="inline width0 height0 str600">here</a>. Please make sure to take a screenshot of the transaction receipt and upload it below.</p>
                            <br>
                            <form action="/paymentUpload" method="POST"  enctype="multipart/form-data" class="colorPrimary gap10">
                                <input type="hidden" name="id" value="<%= request.id %>">
                                <div class="field">
                                    <label for="">Payment Method</label>
                                    <div class="selectBar">
                                        <select name="payMode" id="payMode" required>
                                            <option value="">Select Method</option>
                                            <option value="Cash">Cash</option>
                                            <option value="GCash">GCash</option>
                                            <option value="Maya">Maya</option>
                                            <option value="Bank Deposit">Bank Deposit</option>
                                            <option value="Bank Transfer">Bank Transfer</option>
                                            <option value="Credit Card">Credit Card</option>
                                            <option value="Debit Card">Debit Card</option>
                                            <option value="Bayad Center">Bayad Center</option>
                                            <option value="7-Eleven">7-Eleven (Cliqq/Bills Payment)</option>
                                        </select>                            
                                    </div>
                                </div>
                                <div class="field">
                                    <label for="">Upload your Proof of Payment here</label>
                                    <input name="payPhoto" type="file" required>
                                </div>
                                <div class="field alignEnd">
                                    <button class="nav pnav w120">Upload</button>
                                </div>
                            </form>
                        <% } else if (request.status === "For Verification") { %>
                            <p class="">Please give us 24 hours to verify your payment. Thank you.</p>
                        <% } else if (request.status === "Verified") { %>
                            <p class="">Your payment has been verified. We will notify you via the email you provided once your document is ready for release.</p>
                        <% } else if (request.status === "For Release") { %>
                            <div class="height0 col bgSoft padding20 corner15">
                                    
                                <div class="bgWhite height0 gap5 justifyCenter alignCenter width0 padding5 corner10 darkShadow relative">
                                    <div class="height0 col hidden">
                                        <p class="size14">
                                            <%= user.fName %> <%= user.mName %> <%= user.lName %> <%= user.xName %>
                                        </p>
                                        <p class="size14"><%= user.role %></p>
                                        <p class="size14"><%= user.course %></p>
                                        <p class="size14"><%= request.tr %></p>
                                        <p class="size14"><%= request.requestAt %></p>
                                    </div>
                                    <canvas id="qrcodeCanvas" width="100" height="100" class="hMax150 wMax150"></canvas>
                                    <a href="javascript:void(0)" class="nav cnav qrBtn absolute bottom5 right5 glass"><i class="fas fa-download"></i></a>
                                </div>
                            </div>
                            <script>
                                document.addEventListener('DOMContentLoaded', () => {
                                    const downloadBtn = document.querySelector('.qrBtn');
                                    const canvasEl = document.getElementById('qrcodeCanvas');

                                    if (!downloadBtn || !canvasEl) return;

                                    downloadBtn.addEventListener('click', () => {
                                        // Convert canvas to data URL first
                                        const dataURL = canvasEl.toDataURL('image/png');

                                        // Detect iPhone/iPad
                                        const isIOS = /iP(hone|od|ad)/i.test(navigator.userAgent);

                                        if (isIOS) {
                                            // iOS does NOT support download attribute for data URLs
                                            // Solution: open the image in a new tab
                                            const tab = window.open();
                                            tab.document.write(
                                                `<img src="${dataURL}" style="width:100%;height:auto;" />`
                                            );
                                            return;
                                        }

                                        // Desktop + Android: force download
                                        const link = document.createElement('a');
                                        link.href = dataURL;
                                        link.download = 'qrcode.png';

                                        // Must be added to DOM for some mobile browsers
                                        document.body.appendChild(link);

                                        link.click();

                                        document.body.removeChild(link);
                                    });
                                });
                            </script>
                            <script>
                                // Format the data into a readable string indicating transaction verification
                                const requestDataFormatted = `Transaction Verified! 
                                Name: ${"<%= user.fName %>"} ${"<%= user.mName %>"} ${"<%= user.lName %>"} ${"<%= user.xName %>"},
                                Role: ${"<%= user.role %>"},
                                Course: ${"<%= user.course %>"},
                                TR: ${"<%= request.tr %>"}`;
                            
                                // Generate the QR code with formatted data
                                const canvas = document.getElementById('qrcodeCanvas');
                                QRCode.toCanvas(canvas, requestDataFormatted, function (error) {
                                    if (error) {
                                        console.error(error);
                                    } else {
                                        console.log('QR code generated successfully');
                                    }
                                });
                            </script>
                        <% } else if (request.status === "Claimed") { %>
                            <p class="">Your document has been claimed!</p>
                        <% } else { %>
                        <p class="">No Remarks</p>
                        <% } %>
                    </section>
                </section>
                <% } %>

            </section>
        </section>
        <% if (["For Payment", "For Verification","Verified","Claimed", "For Release"].includes(request.status) && request.payPhoto) { %>
            <section class="col width20">
                <section class="justifyStart"><p class="rem18">Payment Details</p></section>
                <section class="corner20 col bgWhite gap5">
                    <section class="justifyStart bgYellow corner14"><p class="size12">Method: <%= request.payMode || 'Gcash' %></p></section>
                    <img src="<%= request.payPhoto ? request.payPhoto : '/images/annPhoto2.jpg' %>" alt="Profile" onerror="this.onerror=null; this.src='/images/annPhoto2.jpg';" class="borderPrimary width100 corner20">
                </section>
            </section>
        <% } %>
    </section>