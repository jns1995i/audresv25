<% layout('template') %>
    <br>
<section class="col gap10 padding10 width40 bgSoft colorPrimary corner15" id="card1">
    <%
        function formatCustomDate(dateString) {
        const d = new Date(dateString);
        const now = new Date();

        const oneDay = 24 * 60 * 60 * 1000;
        const diffDays = Math.floor((now - d) / oneDay);

        // Today
        if (diffDays === 0) return "Today";

        // Yesterday
        if (diffDays === 1) return "Yesterday";

        // Format month + day
        const options = { month: "short", day: "numeric" };
        let formatted = d.toLocaleDateString("en-US", options);

        // Add year if not current year
        if (d.getFullYear() !== now.getFullYear()) {
            formatted += ", " + d.getFullYear();
        }

        return formatted;
        }
    %>

    <section class="col justifyStart padding0 alignStart relative">
        <section class="padding15 paddingInline5 gap10 justifyStart">
            <a href="/prf" class="porcelain h45 w45 corner500 liquid padding0">
                <img src="<%= user.photo ? user.photo : '/images/profile.png' %>" alt="Profile" onerror="this.onerror=null; this.src='/images/profile.png';" class="height90 width90 borderPrimary">
            </a>
            <p class="size30 str500">Hi, <%= user.fName %></p>
        </section>
        <section class="abstractBG1 corner15 col alignStart relative padding20">
            <p class="size16 str400 width70">Requesting Document</p>
            <p class="size16 str400 width70">Made Easy For you!</p>
            <br>
            <a href="/reqPre" class="nav glass liquid glowImg2"><i class="fas fa-plus"></i> Request Now</a>
        </section>
    </section>
    <br>

    <% if (requests && requests.length > 0) { %>
        <div class="height0 justifyBetween padding5">
            <p class="rem16 str400">Recent Request</p>
            <% if (requests && requests.length > 0) { %>
            <a href="/reqAll" class="rem16 paddingLeft10 str400">See All</a>
            <% } %>
        </div>

        <section class="bgWhite col gap5 corner15">
            <% requests.slice(0, 3).forEach(req => { %>
                <a href="/reqView/<%= req._id %>" class="width100 col alignStart padding10 shadow1 corner10 relative">
                    <% if (req.items && req.items.length > 0) { %>
                        <% req.items.forEach(item => { %>
                        <p class="size12 str500"><%= item.qty %> <%= item.type %></p>
                        <% }) %>
                    <% } else { %>
                        <p class="size12 str500">No items found for this request.</p>
                    <% } %>
                    <% if ( req.holdAt ) { %>
                        <div class="size12 str400 padding0 cornerRem1 str500 width0 statIcon bgRed100"  style="background-color: transparent;">
                            On Hold
                        </div>
                    <% } else if ( req.declineAt ) { %>
                        <div class="size12 str400 padding0 cornerRem1 str500 width0 statIcon bgRed100 border0"  style="background-color: transparent;">
                            Declined
                        </div>
                    <% } else { %>
                        <div class="size12 str400 padding0 cornerRem1 str500 width0 statIcon
                        <% if ( req.status === "Pending" ) { %>
                            bgBlue100
                        <% } else if ( req.status === "Reviewed" ) { %>
                            bgViolet100
                        <% } else if ( req.status === "Assessed" ) { %>
                            bgYellow100
                        <% } else if ( req.status === "Verified" ) { %>
                            bgGreen100
                        <% } else if ( req.status === "For Release" ) { %>
                            bgGreen100
                        <% } else if ( req.status === "Claimed" ) { %>
                            bgGray100
                        <% } else { %>
                            bgBlue100
                        <% } %> border0
                        " style="background-color: transparent;">
                            <i class="fas fa-hourglass inline rem1 w15 h15 hidden"></i>
                            <%= req.status %>
                        </div>
                    <% } %>
                    <p class="size12 darkGray absolute right10 top10"><%= formatCustomDate(req.createdAt) %></p>
                </a>
            <% }) %>
        </section>
    <% } else { %>
        <div class="height0 padding5">
            <p class="rem16 str400">You have no requests yet!</p>
        </div>
    <% } %>

<br>
</section>
<section class="col gap10 padding0 width30" id="card2">
    <section class=" corner10 borderGray textCenter">
        <p><i class="fas fa-info-circle marginRight5"></i> Service Hours: Monday–Friday, 8:00 AM–5:00 PM. Requests sent after hours are queued for the next working day.</p>
    </section>
    <div class="height0 padding10 gap10 width100 justifyStart bgWhite corner10 col">
        <a href="#" class="nav cnav disabled opacity0 absolute right5 bottom5 scale4"><i class="fas fa-question-circle"></i></a>
        <div class="height0 padding10 border0 borderRadius10 justifyBetween width100 gap10 relative corner15">
            <p class="size16 gap10 alignCenter">Need Help?</p>
            <a href="/ins2" class="nav porcelain colorPrimary">Learn more here <i class="fas fa-chevron-right"></i></a>
        </div>
        <video autoplay muted loop playsinline controls class="width100 cornerRem1" id="vidCard"><source src="/images/video.mp4" type="video/mp4"></video>
    </div>
</section>